# 产品逻辑与需求文档

## 一、产品概述

企业对象存储系统是一款面向企业的多租户文件存储解决方案，旨在提供安全、高效、易用的文件管理服务。系统采用多租户架构，支持群组和项目隔离，实现细粒度的权限控制和完善的审计功能。

## 二、核心功能需求

### 1. 用户与认证系统
- 用户注册、登录功能
- 基于JWT的身份认证
- 密码安全策略与密码重置

### 2. 多租户架构
- 群组（公司）作为顶级租户单位
- 每个群组独立的资源空间与权限控制
- 群组成员管理与角色分配
- 群组级存储容量管理与监控

### 3. 项目管理
- 在群组内创建多个项目
- 项目路径隔离
- 项目级权限分配
- 项目资源统计与监控

### 4. 文件管理
- 文件上传、下载、删除操作
- 文件夹创建与管理
- 文件版本控制
- 文件秒传（基于哈希去重）
- 大文件分片上传
- 回收站与文件恢复（所有删除均为逻辑删除）
- 文件移动与复制
- 文件预览支持

### 5. 权限控制
- 角色分类：系统管理员、群组管理员、普通用户
- 细粒度资源访问控制
- 权限继承与覆盖机制
- 临时权限与过期策略

### 6. 文件共享
- 内部文件共享（用户间）
- 外部文件共享（生成访问链接）
- 共享安全控制（密码、过期时间、下载次数限制）

### 7. 审计与日志
- 完整操作日志记录
- 用户行为追踪
- 敏感操作告警
- 日志查询与导出

### 8. 存储管理
- 存储容量监控
- 数据留存与过期策略
- 冷热数据分级存储
- 存储使用趋势分析

## 三、用户角色与权限

### 用户角色定义
1. **系统管理员**：系统最高权限，管理所有群组和数据，可执行物理删除操作，由普通用户通过注册然后提升获得
2. **群组管理员**：群组的管理者，同时也是群组下所有项目的管理员
3. **普通用户**：对项目内文件有基本的增删改查权限，删除操作是逻辑删除

### 权限矩阵

| 操作\角色 | 系统管理员 | 群组管理员 | 普通用户 |
|----------|------------|-----------|----------|
| 创建群组 | ✓ | ✓ | ✓ |
| 管理群组成员 | ✓ | ✓ | ✗ |
| 创建项目 | ✓ | ✓ | ✗ |
| 管理项目成员 | ✓ | ✓ | ✗ |
| 上传文件 | ✓ | ✓ | ✓ |
| 下载文件 | ✓ | ✓ | ✓ |
| 逻辑删除文件 | ✓ | ✓ | ✓ |
| 物理删除文件 | ✓ | ✗ | ✗ |
| 共享文件 | ✓ | ✓ | ✓ |
| 查看审计日志 | ✓ | ✓ | ✗ |

### 角色设计策略详细说明

#### 1. 多级RBAC权限模型

系统采用多级基于角色的访问控制(RBAC)模型，通过预定义的角色和权限集合，明确各类用户能够执行的操作范围。本系统权限设计分为两个层级：

- **系统级权限**：控制整个系统的管理功能访问
- **群组级权限**：控制群组内的资源和成员管理

#### 2. 角色职责与边界

1. **系统管理员**
   - 系统最高权限角色
   - 管理整个系统的用户、群组和配置
   - 可查看所有群组和项目的操作日志
   - 可重置用户密码和解锁账户
   - 能够管理系统级别配置参数
   - 唯一可以执行物理删除操作的角色
   - 通常由普通用户注册后提升获得

2. **群组管理员**
   - 群组的管理者
   - 创建和管理群组设置（存储配额、安全策略）
   - 添加/移除群组成员及分配角色
   - 创建和管理群组内的项目
   - 拥有群组内所有项目的管理权限
   - 可查看群组内的所有审计日志
   - 只能执行逻辑删除，不能物理删除数据

3. **普通用户**
   - 可在已授权的项目中进行基本操作
   - 可上传、下载、修改和（逻辑）删除文件
   - 可以创建文件夹组织自己的文件
   - 不能管理群组或项目设置
   - 不能查看审计日志
   - 对文件的删除操作均为逻辑删除，可从回收站恢复

#### 3. 权限继承与委派机制

- **向下继承原则**：高级角色自动拥有其下级角色的所有权限
- **委派限制原则**：角色只能委派自身拥有的权限，不能委派更高级别的权限

#### 4. 权限控制核心策略

1. **最小权限原则**
   - 默认授予用户完成任务所需的最小权限集合
   - 仅在必要时提升权限级别
   - 定期审计和调整权限分配

2. **职责分离机制**
   - 关键操作需要不同角色协作完成
   - 敏感操作（如批量删除）需要更高权限确认

3. **时效性权限**
   - 支持临时权限授予机制
   - 权限可设置有效期，到期自动失效
   - 非活跃用户权限自动降级或暂停

4. **上下文感知权限**
   - 基于操作时间、位置等上下文信息动态调整权限
   - 非常规时间或位置的敏感操作可能触发二次验证

5. **资源所有权规则**
   - 文件创建者对自己的文件拥有特殊权限
   - 特定场景下，所有权可以转移
   - 群组管理员对群组内所有资源拥有管理权

## 四、业务流程

### 1. 用户注册与群组创建流程
1. 用户注册系统账号
2. 创建新群组或加入现有群组
3. 如创建新群组，自动成为群组管理员
4. 设置群组基本信息与邀请码

### 2. 文件上传流程
1. 用户选择目标项目与路径
2. 客户端计算文件哈希值
3. 发送哈希值至服务端检查是否存在（秒传检查）
4. 如文件已存在，直接创建引用关系（秒传）
5. 如文件不存在，获取上传授权
6. 使用预签名URL上传文件
7. 上传完成后确认，记录文件元数据

### 3. 文件权限控制流程
1. 用户请求文件操作
2. 系统检查用户身份与所属群组
3. 验证用户在目标项目中的权限
4. 对于文件操作，检查文件所有权限制
5. 允许或拒绝操作，并记录审计日志

### 4. 分享文件流程
1. 用户选择需要分享的文件
2. 设置分享参数（密码、过期时间、下载限制）
3. 系统生成唯一分享链接
4. 外部用户通过链接访问文件
5. 系统验证分享链接的有效性与限制条件
6. 允许下载并记录分享访问日志

### 5. 文件删除与恢复流程
1. 用户请求删除文件
2. 系统验证用户删除权限
3. 文件标记为"已删除"状态（逻辑删除）
4. 文件移至回收站，设置保留期
5. 用户可在回收站查看已删除文件
6. 有权限的用户可恢复文件
7. 系统管理员可以执行物理删除
8. 超过保留期的文件可被系统自动清理

## 五、非功能需求

### 1. 性能需求
- 并发用户：支持1000+同时在线用户
- 响应时间：API响应时间<200ms
- 上传速度：支持100MB/s的上传速度
- 大文件支持：单文件最大支持50GB

### 2. 安全需求
- 传输加密：全站HTTPS
- 数据加密：支持存储加密
- 访问控制：细粒度权限管理
- 攻击防护：防SQL注入、XSS、CSRF
- 异常检测：监控异常登录与敏感操作

### 3. 可靠性需求
- 系统可用性：99.9%
- 数据持久性：99.999999%
- 备份策略：定期备份与灾难恢复
- 错误处理：完善的错误处理机制

### 4. 可扩展性需求
- 水平扩展：支持服务实例扩展
- 存储扩展：支持存储容量线性扩展
- 功能扩展：模块化设计，支持新功能扩展

### 5. 兼容性需求
- 浏览器兼容：支持主流浏览器
- 移动设备：支持移动端访问
- API兼容：提供标准RESTful API
- 第三方集成：支持WebDAV、S3协议 