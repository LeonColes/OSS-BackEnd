# 权限系统设计文档

## 1. 系统概述

本系统采用基于角色的访问控制（RBAC）模型结合Casbin动态权限管理框架，实现灵活、可扩展的权限管理系统。

## 2. 核心概念

### 2.1 用户（User）

用户是系统的使用者，每个用户可以拥有一个或多个角色。用户本身不直接拥有权限，而是通过所属的角色间接获得权限。

### 2.2 角色（Role）

角色是权限的集合，代表了系统中的一类用户可以执行的操作。系统预定义了几个基本角色：

- **ADMIN**: 系统管理员，拥有全部权限
- **GROUP_ADMIN**: 群组管理员，负责管理群组、项目及成员
- **MEMBER**: 普通成员，可以参与项目并进行基本操作

### 2.3 资源（Resource）

系统中可被访问的对象，包括：

- **projects**: 项目
- **groups**: 群组
- **files**: 文件
- **users**: 用户
- **roles**: 角色

### 2.4 动作（Action）

用户可以对资源执行的操作：

- **create**: 创建
- **read**: 读取
- **update**: 更新
- **delete**: 删除

### 2.5 域（Domain）

表示资源所属的作用域，在本系统中主要用于区分不同的群组或项目。

## 3. 权限分配流程

### 3.1 用户注册

1. 用户注册时，默认分配 **MEMBER** 角色
2. 系统将用户-角色关系保存到数据库
3. 同时更新Casbin策略存储

### 3.2 角色分配

系统管理员或群组管理员可以为用户分配或移除角色：

1. 通过API调用角色分配接口
2. 系统更新用户-角色关系表
3. 同步更新Casbin策略

### 3.3 权限检查

当用户尝试访问资源时：

1. 系统从当前请求中获取用户身份、目标资源、操作类型和域
2. 调用Casbin执行器检查用户是否有权限
3. 根据检查结果允许或拒绝访问

## 4. 数据模型

### 4.1 用户-角色关系

```
用户(User) <--多对多--> 角色(Role)
```

通过中间表 `user_roles` 建立用户与角色的多对多关系。

### 4.2 Casbin策略规则

策略定义在 `configs/policy.csv` 文件中，格式为：

```
p, <角色>, <域>, <资源>, <动作>
```

例如：
```
p, ADMIN, *, *, *  // 管理员在所有域对所有资源有所有操作权限
p, MEMBER, *, projects, read  // 成员可以读取任何域中的项目
```

## 5. 角色功能

### 5.1 系统管理员 (ADMIN)

- 管理所有系统资源
- 创建和管理群组
- 分配群组管理员
- 查看系统级统计数据

### 5.2 群组管理员 (GROUP_ADMIN)

- 管理群组和项目
- 添加和移除项目成员
- 管理项目文件和权限
- 查看群组统计数据

### 5.3 普通成员 (MEMBER)

- 查看参与的项目
- 上传、下载、管理文件
- 查看个人统计数据

## 6. 群组与权限系统的关系

群组作为组织单位，主要功能是：

1. 作为权限控制的"域"，实现资源隔离
2. 提供用户组织和管理的层级结构
3. 允许用户在不同群组中拥有不同角色和权限

## 7. 权限验证流程

```
用户请求 → JWT身份验证 → 获取用户角色 → Casbin权限检查 → 允许/拒绝访问
```

实现机制：
1. `auth_middleware.go`: 处理权限验证逻辑
2. `auth_service.go`: 提供角色和权限管理功能
3. `rbac_model.conf`: 定义权限校验规则
4. `policy.csv`: 存储具体权限策略

## 8. 设计简化说明

本设计对原有权限结构进行了简化：

1. 移除了项目管理员(PROJECT_ADMIN)角色，由群组管理员直接管理项目和用户
2. 普通成员(MEMBER)自动拥有对项目和文件的基本操作权限
3. 角色层级从三级减少为两级，使权限结构更加扁平化和直观

这种设计的优势：
- 降低了权限管理的复杂度
- 减少了角色之间的权限边界问题
- 简化了用户操作流程
- 提高了系统整体可用性 