# 架构设计文档

## 目录

- [系统概述](#系统概述)
- [架构设计原则](#架构设计原则)
- [整体架构](#整体架构)
- [技术栈选型](#技术栈选型)
- [核心模块设计](#核心模块设计)
- [存储设计](#存储设计)
- [认证与授权设计](#认证与授权设计)
- [部署架构](#部署架构)
- [性能与扩展性](#性能与扩展性)
- [安全设计](#安全设计)

## 系统概述

OSS-Backend是一个对象存储服务后端系统，提供文件存储、管理、权限控制等功能。系统基于微服务架构设计，采用Go语言开发，具备高并发、高可用和可扩展的特性。

### 主要功能

- 文件上传、下载、管理
- 用户认证与授权
- 多租户支持
- 访问控制与权限管理
- 文件版本控制
- 数据加密与安全保护
- 系统监控与日志追踪

## 架构设计原则

系统设计遵循以下原则：

1. **领域驱动设计 (DDD)**: 基于业务领域构建系统架构
2. **整洁架构原则**: 关注点分离，依赖由外向内
3. **微服务架构**: 服务解耦，独立部署和扩展
4. **安全第一**: 数据安全和访问控制贯穿设计始终
5. **可扩展性**: 支持水平扩展以应对业务增长
6. **可观测性**: 内置监控、日志和追踪能力
7. **云原生设计**: 适配现代云环境部署和运维

## 整体架构

系统采用分层架构设计，主要分为以下层次：

```
┌─────────────────────────────────────────────────────────────┐
│                      接口层 (Interfaces)                     │
│  HTTP API, gRPC, WebSocket, GraphQL                         │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────┐
│                      应用层 (Application)                    │
│  服务编排, 用例实现, 事务管理                                │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────┐
│                      领域层 (Domain)                         │
│  业务实体, 值对象, 领域服务, 聚合                            │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────┐
│                  基础设施层 (Infrastructure)                 │
│  数据库访问, 第三方集成, 消息队列, 缓存等                     │
└─────────────────────────────────────────────────────────────┘
```

### 核心服务组件

- **API网关**: 统一入口，请求路由，认证鉴权
- **用户服务**: 用户管理，身份认证
- **权限服务**: 基于RBAC+Casbin的权限控制
- **存储服务**: 文件存储管理，包含元数据和数据存储
- **任务调度服务**: 异步任务处理
- **通知服务**: 系统通知和消息推送
- **监控服务**: 系统监控和日志收集

## 技术栈选型

### 编程语言与框架

- **主语言**: Go 1.21+
- **Web框架**: Gin
- **RPC框架**: gRPC
- **API文档**: Swagger/OpenAPI

### 存储层

- **关系型数据库**: PostgreSQL (元数据存储)
- **对象存储**: MinIO (文件数据存储)
- **缓存**: Redis
- **搜索引擎**: Elasticsearch (可选)

### 中间件与基础设施

- **消息队列**: Kafka/NATS
- **服务发现**: Consul/etcd
- **日志收集**: ELK/Loki
- **监控系统**: Prometheus + Grafana
- **链路追踪**: Jaeger/Zipkin

### 部署与运维

- **容器化**: Docker
- **编排系统**: Kubernetes
- **CI/CD**: GitHub Actions/Jenkins
- **配置管理**: Helm

## 核心模块设计

### 用户管理模块

```
┌─────────────────┐      ┌────────────────┐     ┌────────────────┐
│     用户接口     │─────▶│    用户应用服务  │────▶│    用户领域    │
└─────────────────┘      └────────────────┘     └────────────────┘
                                 │                       │
                                 ▼                       ▼
                         ┌────────────────┐     ┌────────────────┐
                         │   用户资源库    │◀────▶│    用户存储    │
                         └────────────────┘     └────────────────┘
```

提供用户注册、登录、个人信息管理、认证等功能，包括：

- 多种认证方式支持（账密、OAuth、LDAP等）
- 用户信息管理
- 安全设置与MFA
- 用户组管理

### 权限管理模块

基于RBAC模型和Casbin实现的动态权限系统，支持多维度的访问控制：

- 角色定义与管理
- 权限分配与继承
- 资源ACL控制
- API级别权限验证
- 数据行级权限控制

### 文件存储模块

```
┌─────────────────┐      ┌────────────────┐     ┌────────────────┐
│   文件操作接口   │─────▶│  文件应用服务   │────▶│    文件领域    │
└─────────────────┘      └────────────────┘     └────────────────┘
                                 │                       │
                                 ▼                       ▼
                         ┌────────────────┐     ┌────────────────┐
                         │  文件元数据存储 │     │   文件数据存储  │
                         └────────────────┘     └────────────────┘
```

负责文件的上传、下载和管理：

- 大文件分片上传
- 断点续传
- 文件版本控制
- 元数据管理
- 文件加密存储
- 数据去重

### 任务调度模块

处理异步任务和长时间运行的作业：

- 文件处理（压缩、格式转换等）
- 批量操作
- 定时任务
- 重试机制
- 分布式作业调度

## 存储设计

### 元数据存储

使用PostgreSQL存储系统元数据：

- 用户信息
- 权限配置
- 文件元数据
- 系统配置

核心表结构：

```
users               - 用户信息
groups              - 用户组信息
roles               - 角色定义
permissions         - 权限定义
role_permissions    - 角色权限关联
user_roles          - 用户角色关联
files               - 文件元数据
file_versions       - 文件版本信息
tags                - 标签信息
file_tags           - 文件标签关联
```

### 文件数据存储

使用MinIO作为对象存储后端：

- 按租户隔离存储桶
- 分层存储策略
- 内容寻址存储
- 加密存储支持

## 认证与授权设计

### 认证流程

1. **多因素认证**: 支持密码、令牌、证书等多种认证方式
2. **JWT令牌**: 无状态会话管理
3. **OAuth集成**: 支持第三方登录
4. **会话管理**: 登录状态控制与安全退出

### 授权模型

采用RBAC (Role-Based Access Control) + Casbin实现动态权限控制：

```
User ──┐
        ├──► Role ──► Permission ──► Resource
Group ─┘
```

Casbin策略示例：

```
[request_definition]
r = sub, obj, act

[policy_definition]
p = sub, obj, act

[role_definition]
g = _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub) && r.obj == p.obj && r.act == p.act
```

## 部署架构

系统支持多种部署模式：

### 单体部署

适用于小型部署场景：

```
┌─────────────────────────┐
│        OSS-Backend      │
└─────────────┬───────────┘
              │
┌─────────────▼───────────┐
│      PostgreSQL/Redis   │
└─────────────┬───────────┘
              │
┌─────────────▼───────────┐
│          MinIO          │
└─────────────────────────┘
```

### 微服务部署

适用于大型生产环境：

```
┌─────────────────────────────────────────────────────────────┐
│                         API Gateway                         │
└───┬─────────────┬────────────────┬────────────────┬─────────┘
    │             │                │                │
┌───▼────┐   ┌────▼───┐    ┌───────▼────┐    ┌──────▼─────┐
│ 用户服务 │   │权限服务 │    │  存储服务  │    │ 任务服务   │
└───┬────┘   └────┬───┘    └───────┬────┘    └──────┬─────┘
    │             │                │                │
    └─────────────┴────────────────┴────────────────┘
                           │
                 ┌─────────▼─────────┐
                 │   Shared DB/Cache │
                 └─────────┬─────────┘
                           │
                 ┌─────────▼─────────┐
                 │  Object Storage   │
                 └───────────────────┘
```

## 性能与扩展性

### 性能优化策略

- **连接池管理**: 优化数据库连接
- **缓存策略**: 多级缓存减少I/O
- **异步处理**: 非关键流程异步化
- **限流与降级**: 保护系统稳定性
- **预热与预取**: 减少冷启动开销

### 扩展性设计

- **水平扩展**: 无状态设计支持集群扩展
- **分片策略**: 按租户/时间分片数据
- **容量规划**: 弹性资源分配
- **热点识别**: 动态调整热点资源

## 安全设计

### 数据安全

- **传输加密**: TLS/SSL通信加密
- **存储加密**: 文件加密存储
- **密钥管理**: KMS密钥统一管理
- **数据脱敏**: 敏感信息脱敏展示

### 应用安全

- **请求验证**: 输入数据验证
- **CSRF防护**: 跨站请求伪造防护
- **XSS防御**: 跨站脚本攻击防御
- **权限检查**: 多层次权限校验
- **日志审计**: 关键操作审计追踪

---

该文档将随系统发展持续更新，所有重大架构变更需经过架构评审并更新本文档。 