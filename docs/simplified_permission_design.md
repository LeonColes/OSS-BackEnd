# OSS-Backend 简化权限系统设计

## 1. 系统概述

本系统采用简化的RBAC权限控制模型，结合多租户（域）设计，实现系统级和群组级两层权限隔离。系统支持用户自主创建群组，群组管理员直接管理成员权限，确保不同群组内资源的安全隔离。

### 1.1 权限设计理念

- **简化角色结构**：仅保留系统管理员、群组管理员和普通成员三种角色
- **降低复杂度**：移除项目管理员角色，由群组管理员直接管理项目和成员
- **灵活权限控制**：通过权限标签对普通成员授予细粒度权限，而非通过角色提升
- **用户自主创建**：允许用户自主创建群组，减轻系统管理负担

### 1.2 核心特性

- 自主创建群组：注册用户可创建自己的群组，成为群组管理员
- 权限标签管理：通过权限标签（读取、上传、删除等）灵活控制普通成员权限
- 基于Casbin实现：保留原有的权限校验框架，优化角色和规则设计
- 统一中间件校验：使用统一的权限中间件处理所有请求的权限验证

## 2. 角色设计

### 2.1 角色体系

系统定义了三个核心角色：

| 角色名称 | 角色编码 | 职责概述 |
|---------|----------|---------|
| 系统管理员 | SUPER_ADMIN | 拥有系统全局权限，管理所有群组和资源 |
| 群组管理员 | GROUP_ADMIN | 管理群组资源、项目和成员权限 |
| 普通成员 | MEMBER | 根据分配的权限参与群组协作 |

### 2.2 角色权限矩阵

| 功能/操作 | 系统管理员 | 群组管理员 | 普通成员 |
|----------|----------|-----------|---------|
| **用户管理** |  |  |  |
| 查看个人信息 | ✓ | ✓ | ✓ |
| 修改个人信息 | ✓ | ✓ | ✓ |
| 查看用户列表 | ✓ | ✓ | ✗ |
| 创建群组 | ✓ | ✓ | ✓ |
| 查看群组列表 | ✓ | ✓ | ✓(仅参与的) |
| **项目管理** |  |  |  |
| 创建项目 | ✓ | ✓ | ✗ |
| 编辑项目信息 | ✓ | ✓ | ✗ |
| 查看所有项目 | ✓ | ✓(群组内) | ✓(已授权) |
| 删除项目(逻辑) | ✓ | ✓ | ✗ |
| **成员管理** |  |  |  |
| 添加群组成员 | ✓ | ✓ | ✗ |
| 移除群组成员 | ✓ | ✓ | ✗ |
| 分配成员权限 | ✓ | ✓ | ✗ |
| **文件管理** |  |  |  |
| 上传文件 | ✓ | ✓ | 权限控制 |
| 下载文件 | ✓ | ✓ | 权限控制 |
| 删除文件(逻辑) | ✓ | ✓ | 权限控制 |
| 查看文件列表 | ✓ | ✓ | 权限控制 |

## 3. 群组创建与管理

### 3.1 群组创建流程

1. **自主创建**：
   - 任何注册用户可创建群组
   - 创建者自动成为该群组的群组管理员
   - 系统可通过配额限制单用户创建群组数量

```
用户 -> 登录系统 -> 选择"创建群组" -> 填写群组信息 -> 确认创建 -> 成为群组管理员
```

2. **邀请加入**：
   - 群组管理员可生成邀请链接或邀请码
   - 被邀请用户通过链接/邀请码加入群组
   - 加入时默认为普通成员角色

```
群组管理员 -> 生成邀请链接 -> 分享给用户 -> 用户点击链接 -> 确认加入 -> 成为普通成员
```

### 3.2 成员权限管理

群组管理员可通过权限标签直接管理成员权限，无需提升为项目管理员：

| 权限标签 | 说明 | 默认分配 |
|---------|------|---------|
| read | 读取权限，可查看文件 | 所有成员 |
| upload | 上传权限，可上传新文件 | 所有成员 |
| download | 下载权限，可下载文件 | 所有成员 |
| delete | 删除权限，可删除文件 | 特定成员 |
| share | 分享权限，可分享文件给外部用户 | 特定成员 |
| admin | 管理权限，可管理项目设置(非成员) | 仅管理员 |

权限分配示例：
```go
// 为用户分配特定权限
casbinService.AddPolicy("user:123", "group:456", "file", "upload")

// 移除用户权限
casbinService.RemovePolicy("user:123", "group:456", "file", "delete")
```

## 4. 权限实现机制

### 4.1 Casbin模型保持不变

继续使用RBAC with Domains模型：

```conf
[request_definition]
r = sub, dom, obj, act

[policy_definition]
p = sub, dom, obj, act

[role_definition]
g = _, _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub, r.dom) && r.dom == p.dom && (r.obj == p.obj || p.obj == '*') && (r.act == p.act || p.act == '*')
```

### 4.2 统一权限中间件

使用统一的权限验证中间件简化权限控制逻辑：

```go
// 示例：
router.POST("/api/oss/group/:id/file/upload", 
    jwtMiddleware.AuthMiddleware(), 
    authzMiddleware.AuthCheck(middleware.LevelGroup, "file"),
    fileController.UploadFile)
```

## 5. 权限设置界面

对于普通成员权限管理，提供直观的权限设置界面：

1. **成员列表**：显示群组中所有成员
2. **权限矩阵**：每个成员对应的权限标签列表
3. **快速设置**：预设权限组合（如"只读"、"编辑者"、"完全访问"）
4. **权限继承**：可从项目级或文件夹级继承权限设置

## 6. 迁移建议

从现有三级权限模型迁移到简化模型的步骤：

1. 将现有PROJECT_ADMIN角色用户转换为具有特定权限标签的普通成员
2. 更新Casbin策略，移除项目管理员角色相关规则
3. 更新中间件，使用统一的权限校验流程
4. 修改前端界面，调整角色显示和权限设置

## 7. 总结

简化后的权限设计保持了系统的安全性和灵活性，同时降低了复杂度：
- 减少角色层级，简化权限管理
- 支持用户自主创建群组，提高系统使用便捷性
- 通过权限标签实现细粒度控制，不依赖复杂角色体系
- 统一的权限校验中间件降低代码冗余和维护成本 